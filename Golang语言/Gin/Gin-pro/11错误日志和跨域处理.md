<center>é”™è¯¯æ—¥å¿—å’Œè·¨åŸŸå¤„ç†</center>





[toc]







## é”™è¯¯æ—¥å¿—å’Œè·¨åŸŸå¤„ç†

> Gin æ¡†æ¶çš„æ—¥å¿—é»˜è®¤æ˜¯åœ¨æ§åˆ¶å°è¾“å‡ºï¼Œæœ¬ç¯‡å°†ä½¿ç”¨ Gin æä¾›çš„ `RecoveryWithWriter()` æ–¹æ³•ï¼Œå°è£…ä¸€ä¸ªä¸­é—´ä»¶ï¼Œä½¿ç”¨ `lumberjack` ä½œä¸ºçš„å†™å…¥å™¨ï¼Œå°†é”™è¯¯æ—¥å¿—å†™å…¥æ–‡ä»¶ä¸­ï¼›åŒæ—¶ä½¿ç”¨ `github.com/gin-contrib/cors` ï¼Œä½œä¸‹è·¨åŸŸå¤„ç†ã€‚





### å®‰è£…

```go
go get -u gopkg.in/natefinch/lumberjack.v2
go get github.com/gin-contrib/cors
```





### Recovery ä¸­é—´ä»¶

> åœ¨ `app/common/response/response.go` æ–‡ä»¶ä¸­ï¼Œæ·»åŠ  `ServerError()` æ–¹æ³•ï¼Œä½œä¸º `RecoveryFunc`

```go
package response

func ServerError(c *gin.Context, err interface{}) {
    msg := "Internal Server Error"
    // éç”Ÿäº§ç¯å¢ƒæ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
    if global.App.Config.App.Env != "production" && os.Getenv(gin.EnvGinMode) != gin.ReleaseMode {
        if _, ok := err.(error); ok {
            msg = err.(error).Error()
        }
    }
    c.JSON(http.StatusInternalServerError, Response{
        http.StatusInternalServerError,
        nil,
        msg,
    })
    c.Abort()
}

```

> æ–°å»º `app/middleware/recovery.go` æ–‡ä»¶ï¼Œç¼–å†™ï¼š

```go
package middleware

import (
    "github.com/gin-gonic/gin"
    "gopkg.in/natefinch/lumberjack.v2"
    "jassue-gin/app/common/response"
    "jassue-gin/global"
)

func CustomRecovery() gin.HandlerFunc {
    return gin.RecoveryWithWriter(
        &lumberjack.Logger{
            Filename:   global.App.Config.Log.RootDir + "/" + global.App.Config.Log.Filename,
            MaxSize:    global.App.Config.Log.MaxSize,
            MaxBackups: global.App.Config.Log.MaxBackups,
            MaxAge:     global.App.Config.Log.MaxAge,
            Compress:   global.App.Config.Log.Compress,
        },
        response.ServerError)
}
```





### CORS è·¨åŸŸå¤„ç†

> æ–°å»º `app/middleware/cors.go` æ–‡ä»¶ï¼Œç¼–å†™ï¼š

```go
package middleware

import (
    "github.com/gin-contrib/cors"
    "github.com/gin-gonic/gin"
)

func Cors() gin.HandlerFunc {
    config := cors.DefaultConfig()
    config.AllowAllOrigins = true
    config.AllowHeaders = []string{"Origin", "Content-Length", "Content-Type", "Authorization"}
    config.AllowCredentials = true
    config.ExposeHeaders = []string{"New-Token", "New-Expires-In", "Content-Disposition"}

    return cors.New(config)
}
```



### ä½¿ç”¨ä¸­é—´ä»¶

> åœ¨ `bootstrap/router.go` æ–‡ä»¶ï¼Œç¼–å†™ï¼š

```go
// user è·¯ç”±
func UserRoutesInit(r *gin.Engine) {

	userRoutes := r.Group("/api/user")

	// ä¸­é—´ä»¶
	userRoutes.Use(gin.Logger(), middleware.Cors())
	userRoutes.Use(gin.Logger(), middleware.CustomRecovery())

	userRoutes.GET("/", controller.UserController{}.User)
	userRoutes.POST("/auth/register", controller.UserController{}.Register)
	userRoutes.POST("/auth/login", controller.Login)

	authRouter := userRoutes.Group("").Use(middleware.JWTAuth(services.AppGuardName))
	{
		authRouter.POST("/auth/info", controller.Info)
		authRouter.POST("/auth/logout", controller.Logout)
		authRouter.POST("/imgeUpload", common.ImageUpload)
	}
}
```







### æµ‹è¯•

> æ¥ç€æŸ¥çœ‹ `storage/logs/app.log` æ–‡ä»¶ï¼Œé”™è¯¯ä¿¡æ¯æˆåŠŸå†™å…¥åˆ°æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```go
[31m2023/10/21 10:29:09 [Recovery] 2023/10/21 - 10:29:09 panic recovered:
POST /api/user/auth/register?invoice_status=0&page_size=10&page_number=1 HTTP/1.1
Host: 127.0.0.1:888
Accept: */*
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Content-Length: 81
Content-Type: text/plain
Token: eyJpdiI6IlZ6VnVlNHI3NHhVK3UweklLSEdaTHc9PSIsInZhbHVlIjoienlER0liVUhrUmZMbVhwOUVOZkdIUGFTaU1hTU1ZaHozZEpwVERxWFVWVT0iLCJtYWMiOiJjZTA3ZDY3MmVmNDBhZWViNzM0Nzg1ZmUxMmVkMDU5MzYyMjZhNGJiMjk5YjgxMWQyNTc0ZDNmYjJjZDY2N2RjIn0=
User-Agent: Apifox/1.0.0 (https://apifox.com)


runtime error: invalid memory address or nil pointer dereference
D:/Golang/src/runtime/panic.go:261 (0x3cf566)
	panicmem: panic(memoryError)
D:/Golang/src/runtime/signal_windows.go:364 (0x3cf536)
	sigpanic: panicmem()
C:/Users/vgoer/go/pkg/mod/gorm.io/gorm@v1.25.5/gorm.go:399 (0x966692)
	(*DB).getInstance: if db.clone > 0 {
C:/Users/vgoer/go/pkg/mod/gorm.io/gorm@v1.25.5/chainable_api.go:201 (0x95c775)
```

