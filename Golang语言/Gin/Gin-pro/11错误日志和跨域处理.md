<center>错误日志和跨域处理</center>





[toc]







## 错误日志和跨域处理

> Gin 框架的日志默认是在控制台输出，本篇将使用 Gin 提供的 `RecoveryWithWriter()` 方法，封装一个中间件，使用 `lumberjack` 作为的写入器，将错误日志写入文件中；同时使用 `github.com/gin-contrib/cors` ，作下跨域处理。





### 安装

```go
go get -u gopkg.in/natefinch/lumberjack.v2
go get github.com/gin-contrib/cors
```





### Recovery 中间件

> 在 `app/common/response/response.go` 文件中，添加 `ServerError()` 方法，作为 `RecoveryFunc`

```go
package response

func ServerError(c *gin.Context, err interface{}) {
    msg := "Internal Server Error"
    // 非生产环境显示具体错误信息
    if global.App.Config.App.Env != "production" && os.Getenv(gin.EnvGinMode) != gin.ReleaseMode {
        if _, ok := err.(error); ok {
            msg = err.(error).Error()
        }
    }
    c.JSON(http.StatusInternalServerError, Response{
        http.StatusInternalServerError,
        nil,
        msg,
    })
    c.Abort()
}

```

> 新建 `app/middleware/recovery.go` 文件，编写：

```go
package middleware

import (
    "github.com/gin-gonic/gin"
    "gopkg.in/natefinch/lumberjack.v2"
    "jassue-gin/app/common/response"
    "jassue-gin/global"
)

func CustomRecovery() gin.HandlerFunc {
    return gin.RecoveryWithWriter(
        &lumberjack.Logger{
            Filename:   global.App.Config.Log.RootDir + "/" + global.App.Config.Log.Filename,
            MaxSize:    global.App.Config.Log.MaxSize,
            MaxBackups: global.App.Config.Log.MaxBackups,
            MaxAge:     global.App.Config.Log.MaxAge,
            Compress:   global.App.Config.Log.Compress,
        },
        response.ServerError)
}
```

