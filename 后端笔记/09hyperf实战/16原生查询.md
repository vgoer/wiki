<center>原生查询</center>





[toc]









## 原生查询

> 读写分离的hyperf.









### 1. 配置文件修改。

> 查看容器ip

```shell
docker inspect mysql_master 
docker inspect mysql_slave1 
docker inspect mysql_slave2 
```



```shell
<?php

declare(strict_types=1);
/**
 * This file is part of Hyperf.
 *
 * @link     https://www.hyperf.io
 * @document https://hyperf.wiki
 * @contact  group@hyperf.io
 * @license  https://github.com/hyperf/hyperf/blob/master/LICENSE
 */
use function Hyperf\Support\env;

return [
    'default' => [
        'driver' => env('DB_DRIVER', 'mysql'),
        'read' => [
            'host' => ['172.17.0.6'],
            'host' => ['172.17.0.7'],
            'username' => env('DB_USERNAME2', 'readuser'),
            'password' => env('DB_PASSWORD2', '123456'),
        ],
        'write' => [
            'host' => ['172.17.0.5'],   // 主
            'username' => env('DB_USERNAME1', 'root'),
            'password' => env('DB_PASSWORD1', 'root'),
        ],
        'sticky'    => true,  // 是否开启sticky, 解决写入数据读取时候延迟问题
        'database' => env('DB_DATABASE', 'test'),
        'port' => env('DB_PORT', 3306),
        // 'username' => env('DB_USERNAME', 'root'),
        // 'password' => env('DB_PASSWORD', 'root123123'),
        'charset' => env('DB_CHARSET', 'utf8'),
        'collation' => env('DB_COLLATION', 'utf8_unicode_ci'),
        'prefix' => env('DB_PREFIX', ''),
        'pool' => [
            'min_connections' => 1,
            'max_connections' => 10,
            'connect_timeout' => 10.0,
            'wait_timeout' => 3.0,
            'heartbeat' => -1,
            'max_idle_time' => (float) env('DB_MAX_IDLE_TIME', 60),
        ],
        'commands' => [
            'gen:model' => [
                'path' => 'app/Model',
                'force_casts' => true,
                'inheritance' => 'Model',
            ],
        ],
    ],
];

```

> 新建迁移：执行

```php
php bin/hyperf.php gen:migration create_users_table --create=users
```

```shell
<?php

use Hyperf\Database\Schema\Schema;
use Hyperf\Database\Schema\Blueprint;
use Hyperf\Database\Migrations\Migration;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->bigIncrements('id');
            $table->string("name", 10)->nullable()->default("")->comment("用户名");
            $table->string("email", 20)->nullable()->default("")->comment("邮箱");
            $table->string("password", 50)->nullable()->default("")->comment("密码");
            $table->datetimes();

            $table->comment("用户表");
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('users');
    }
};

```

```shell
php bin/hyperf.php migrate
```

```shell
php bin/hyperf.php gen:model users
```

```php
<?php

declare(strict_types=1);

namespace App\Model;

use Hyperf\DbConnection\Model\Model;

/**
 * @property int $id 
 * @property string $name 
 * @property string $email 
 * @property string $password 
 * @property \Carbon\Carbon $created_at 
 * @property \Carbon\Carbon $updated_at 
 */
class User extends Model
{
    /**
     * The table associated with the model.
     */
    protected ?string $table = 'users';

    /**
     * The attributes that are mass assignable.
     */
    protected array $fillable = ['name', 'email', 'password'];

    /**
     * The attributes that should be cast to native types.
     */
    protected array $casts = ['id' => 'integer', 'created_at' => 'datetime', 'updated_at' => 'datetime'];
}

```



> 牛逼，同步了。

```php
<?php

declare(strict_types=1);
/**
 * This file is part of Hyperf.
 *
 * @link     https://www.hyperf.io
 * @document https://hyperf.wiki
 * @contact  group@hyperf.io
 * @license  https://github.com/hyperf/hyperf/blob/master/LICENSE
 */

namespace App\Controller;

use Hyperf\DbConnection\Db;
use Hyperf\HttpServer\Annotation\AutoController;

#[AutoController]
class IndexController extends AbstractController
{
    public function index()
    {
        $inserted = Db::insert('INSERT INTO users (id, name, email, password) VALUES (?, ?, ?, ?)', [1, 'Hyperf', 'Hyperf@gmail.com', '123456']); // 返回是否成功 bool
        return $inserted;
    }

    public function getUser()
    {
        $user = Db::select('SELECT * FROM users');
        return $user;
    }

    public function updateUser()
    {
        $updated = Db::update('UPDATE users SET name = ? WHERE id = ?', ['Hyperf', 1]); // 返回是否成功 bool
        return $updated;
    }

    public function deleteUser()
    {
        $deleted = Db::delete('DELETE FROM users WHERE id = ?', [1]); // 返回是否成功 bool
        return $deleted;
    }
    
    
}

```



> 事务：

```php
# 1. 自动事务
<?php
use Hyperf\DbConnection\Db;

Db::transaction(function () {
    Db::table('user')->update(['votes' => 1]);

    Db::table('posts')->delete();
});
```

> 你可以使用 `Db` 的 `transaction` 方法在数据库事务中运行一组操作。如果事务的闭包 `Closure` 中出现一个异常，事务将会回滚。如果事务闭包 `Closure` 执行成功，事务将自动提交。一旦你使用了 `transaction` ， 就不再需要担心手动回滚或提交的问题：

```shell
# 2. 手动事务
use Hyperf\DbConnection\Db;

Db::beginTransaction();
try{

    // Do something...

    Db::commit();
} catch(\Throwable $ex){
    Db::rollBack();
}
```



[输出刚刚执行的 SQL](https://hyperf.wiki/3.1/#/zh-cn/db/quick-start?id=输出刚刚执行的-sql)

> 当前方法仅能用于开发环境，线上部署前一定要去掉，不然会引起严重的内存泄露和数据混淆。

线上记录 `SQL`，请使用 [事件监听](https://hyperf.wiki/3.1/#/zh-cn/db/event)

```php
<?php

use Hyperf\DbConnection\Db;
use Hyperf\Collection\Arr;
use App\Model\Book;

// 启用 SQL 数据记录功能
Db::enableQueryLog();

$book = Book::query()->find(1);

// 打印最后一条 SQL 相关数据
var_dump(Arr::last(Db::getQueryLog()));
```
