<center>后端接口开发</center>





[toc]







## 后端接口开发

> 小程序开发： 
>
> 微信开发：[easywechat](https://easywechat.com/)







### 1. 安装

> 获取key和密钥

![image-20250630110659163](.\assets\image-20250630110659163.png)

```shell
composer require w7corp/easywechat

# 专门easywechat携程适配
composer require limingxinleo/easywechat-classmap
```

> 添加配置：`config/outoload/wechat.php`

```php
<?php



return [
    'default' => [
        [
            /**
             * 账号基本信息，请从微信公众平台/开放平台获取
             */
            'app_id'  => \Hyperf\Support\env('AppID'),         // AppID
            'secret'  => \Hyperf\Support\env('AppSecret'),     // AppSecret
            'token'   => '',          // Token
            'aes_key' => '',                    // EncodingAESKey，兼容与安全模式下请一定要填写！！！

            /**
             * 是否使用 Stable Access Token
             * 默认 false
             * https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/mp-access-token/getStableAccessToken.html
             * true 使用 false 不使用
             */
            'use_stable_access_token' => false,

            /**
             * 接口请求相关配置，超时时间等，具体可用参数请参考：
             * https://github.com/symfony/symfony/blob/5.3/src/Symfony/Contracts/HttpClient/HttpClientInterface.php
             */
            'http' => [
                'throw'  => true, // 状态码非 200、300 时是否抛出异常，默认为开启
                'timeout' => 5.0,
                // 'base_uri' => 'https://api.weixin.qq.com/', // 如果你在国外想要覆盖默认的 url 的时候才使用，根据不同的模块配置不同的 uri

                'retry' => true, // 使用默认重试配置
                //  'retry' => [
                //      // 仅以下状态码重试
                //      'status_codes' => [429, 500]
                //       // 最大重试次数
                //      'max_retries' => 3,
                //      // 请求间隔 (毫秒)
                //      'delay' => 1000,
                //      // 如果设置，每次重试的等待时间都会增加这个系数
                //      // (例如. 首次:1000ms; 第二次: 3 * 1000ms; etc.)
                //      'multiplier' => 3
                //  ],
            ],
        ]
    ]
];
```

> 添加`App\Service\Factory\WechatFactory`

```php
<?php

declare(strict_types=1);
/**
 * This file is part of Hyperf.
 *
 * @link     https://www.hyperf.io
 * @document https://hyperf.wiki
 * @contact  group@hyperf.io
 * @license  https://github.com/hyperf/hyperf/blob/master/LICENSE
 */

namespace App\Service\Factory;

use EasyWeChat\MiniApp\Application;
use Hyperf\Contract\ConfigInterface;
use Psr\Container\ContainerInterface;

class WechatFactory
{
    public function __invoke(ContainerInterface $container)
    {
        $config = $container->get(ConfigInterface::class)->get('wechat.default');

        return new Application($config);
    }
}

```

> 添加一条映射： `config/dependencies.php`

```php
return [
    ....
    EasyWeChat\MiniApp\Application::class => App\Service\Factory\WechatFactory::class,
]
```

> 添加登录： `Service/LoginService.php`

```php
<?php

declare(strict_types=1);
/**
 * This file is part of Hyperf.
 *
 * @link     https://www.hyperf.io
 * @document https://hyperf.wiki
 * @contact  group@hyperf.io
 * @license  https://github.com/hyperf/hyperf/blob/master/LICENSE
 */

namespace App\Service;

use EasyWeChat\MiniApp\Application;
use Hyperf\Codec\Json;
use Hyperf\Di\Annotation\Inject;

class LoginService
{
    #[Inject]
    protected Application $app;

    public function login(string $code)
    {
        $res = $this->app->getClient()->get('/sns/jscode2session', [
            'query' => [
                'appid' => $this->app->getAccount()->getAppId(),
                'secret' => $this->app->getAccount()->getSecret(),
                'js_code' => $code,
                'grant_type' => 'authorization_code',
            ],
        ]);

        return Json::decode($res->getContent());
    }
}

```

> 登录逻辑： `Controller/LoginController.php`

```php
<?php

declare(strict_types=1);
/**
 * This file is part of Hyperf.
 *
 * @link     https://www.hyperf.io
 * @document https://hyperf.wiki
 * @contact  group@hyperf.io
 * @license  https://github.com/hyperf/hyperf/blob/master/LICENSE
 */

namespace App\Controller;

use App\Service\LoginService;
use Hyperf\Di\Annotation\Inject;
use Hyperf\Swagger\Annotation as SA;
use Hyperf\Swagger\Request\SwaggerRequest;

#[SA\HyperfServer('http')]
class LoginController extends Controller
{
    # 注入
    #[Inject]
    protected LoginService $loginService;

    #[SA\Post(path: '/login', summary: '小程序登录', tags: ['登录'])]
    #[SA\RequestBody(content: new SA\JsonContent(properties: [
        new SA\Property(property: 'code', description: '微信授权code', type: 'string', rules: 'required|string'),
    ]))]
    #[SA\Response(response: 200, content: new SA\JsonContent(ref: '#/components/schemas/LoginSchema'))]
    public function login(SwaggerRequest $request)
    {
        $code = (string) $request->input('code');

        $result = $this->loginService->login($code);

        var_dump($result);
        return $this->response->success($result);
    }
}

```

> 前端： index.wxml

```html
<!--index.wxml-->
<navigation-bar title="Weixin" back="{{false}}" color="black" background="#FFF"></navigation-bar>
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <view class="userinfo">
      <block wx:if="{{canIUseNicknameComp && !hasUserInfo}}">
        <button class="avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
          <image class="avatar" src="{{userInfo.avatarUrl}}"></image>
        </button>
        <view class="nickname-wrapper">
          <text class="nickname-label">昵称</text>
          <input type="nickname" class="nickname-input" placeholder="请输入昵称" bind:change="onInputChange" />
        </view>
        <view class="nickname-wrapper">
          <text class="nickname-label">手机号</text>
          <input type="phone" class="nickname-input" placeholder="请输入手机号" 
          bind:change="OnInputPhone" />
        </view>
        <view class="nickname-wrapper">
            <button bindtap="OnClickMe">登录</button>
        </view>
      </block>
      <block wx:elif="{{!hasUserInfo}}">
        <button wx:if="{{canIUseGetUserProfile}}" bindtap="getUserProfile"> 获取头像昵称 </button>
        <view wx:else> 请使用2.10.4及以上版本基础库 </view>
      </block>
      <block wx:else>
        <image bindtap="bindViewTap" class="userinfo-avatar" src="{{userInfo.avatarUrl}}" mode="cover"></image>
        <text class="userinfo-nickname">{{userInfo.nickName}}</text>
      </block>
    </view>
    <view class="usermotto">
      <text class="user-motto">{{motto}}</text>
    </view>
  </view>
</scroll-view>

```

> index.ts

```tsx
// index.ts
// 获取应用实例
const app = getApp<IAppOption>()
const defaultAvatarUrl = 'https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0'

Component({
  data: {
    motto: 'Hello World',
    userInfo: {
      avatarUrl: defaultAvatarUrl,
      nickName: '',
      phone:'',
    },
    hasUserInfo: false,
    canIUseGetUserProfile: wx.canIUse('getUserProfile'),
    canIUseNicknameComp: wx.canIUse('input.type.nickname'),
  },
  methods: {
    // 事件处理函数
    bindViewTap() {
      wx.navigateTo({
        url: '../logs/logs',
      })
    },
    onChooseAvatar(e: any) {
      const { avatarUrl } = e.detail
      const { nickName } = this.data.userInfo
      this.setData({
        "userInfo.avatarUrl": avatarUrl,
        hasUserInfo: nickName && avatarUrl && avatarUrl !== defaultAvatarUrl,
      })
    },
    onInputChange(e: any) {
      const nickName = e.detail.value
      const { avatarUrl } = this.data.userInfo
      this.setData({
        "userInfo.nickName": nickName,
        hasUserInfo: nickName && avatarUrl && avatarUrl !== defaultAvatarUrl,
      })
    },

    OnInputPhone(e: any){
      const phone = e.detail.value
      this.setData({
        "userInfo.phone": phone,
      })
    },

    // 登录
    async OnClickMe(){
      console.log(this.data.userInfo)
      // 登录
      wx.login({
        success: res => {
          console.log(res)
          // 获取信息
          wx.getUserInfo({
            success: res1 =>{
              console.log(res1)
                // 发送 res.code 到后台换取 openId, sessionKey, unionId
                wx.request({
                  url: 'http://127.0.0.1:9501/login',
                  method:"POST",
                  data: {
                    code: res.code
                  },
                  header: {
                    'content-type': 'application/json' // 默认值
                  },
                  success(res) {
                    console.log(res.data)
                  }
                })
            }
          })
        }
      })
    },
    getUserProfile() {
      // 推荐使用wx.getUserProfile获取用户信息，开发者每次通过该接口获取用户个人信息均需用户确认，开发者妥善保管用户快速填写的头像昵称，避免重复弹窗
      wx.getUserProfile({
        desc: '展示用户信息', // 声明获取用户个人信息后的用途，后续会展示在弹窗中，请谨慎填写
        success: (res) => {
          console.log(res)
          this.setData({
            userInfo: res.userInfo,
            hasUserInfo: true
          })
        }
      })
    },
  },
})

```

