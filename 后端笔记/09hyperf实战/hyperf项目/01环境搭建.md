<center>环境搭建</center>



[toc]









### 环境搭建

> 私密空间的小程序。







### 1. 环境搭建

> Hyperf 对系统环境有一些要求，当您使用 Swoole 网络引擎驱动时.
>
> windows不能直接安装，需要使用`wsl`

```shell
# docker 
docker run --name biz_hyperf \
-v /workspace/skeleton:/data/project \
-p 9501:9501 -p 9500:9500 -it \
--privileged -u root \
--entrypoint /bin/sh \
hyperf/hyperf:8.1-alpine-v3.18-swoole-slim
```

> 进入目录，启动服务

```shell
# 官方推荐 用的biz骨架
cd /data/project
composer create-project hyperf/biz-skeleton

cd biz-skeleton
php bin/hyperf.php start
```

> 可以使用的命令 和 `artisan`类似

```shell
php bin/hyperf.php start
```

> 启动： `ip:9501` 我去，看到了。




> 热更新：**重要**

```shell
composer require hyperf/watcher

# 生成配置文件
php bin/hyperf.php vendor:publish hyperf/watcher

# 热更新
php bin/hyperf.php server:watch
```







### 2. 常用组件

```shell
# 文档
composer require "hyperf/swagger:3.1.*" -W

# 验证器
composer require "hyperf/validation:3.1.*" -W

# 发布配置
php bin/hyperf.php vendor:publish hyperf/swagger
php bin/hyperf.php vendor:publish hyperf/validation
```

> 访问页面：
>
> 注意： https://unpkg.hyperf.wiki/ 这里的资源访问不了哦，改成 https://unpkg.com/ 可以用
>
> http://127.0.0.1:9501
>
> http://127.0.0.1:9500/swagger







### 3. 添加数据库

> 启动数据库

```shell
mkdir -p ./mysql_data

# 运行
docker run -d \
  --name my-mysql \
  -e MYSQL_ROOT_PASSWORD=yourpassword \
  -e MYSQL_DATABASE=testdb \
  -p 3306:3306 \
  -v ./mysql_data:/var/lib/mysql \
  mysql:8.0
  
# 测试
docker exec -it my-mysql mysql -uroot -p


# 记得给权限 
sudo chmod -R 777 *
sudo chown -R $USER:$USER *
```

> 添加迁移

```shell
php bin/hyperf.php gen:migration create_users_table --create=users
php bin/hyperf.php gen:migration create_secrets_table --create=secrets
php bin/hyperf.php gen:migration create_contents_table --create=contents
```

```php
# 用户表
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->bigIncrements('id');
            $table->string('openid',64)->unique()->nullable()->default('')->comment('openid');
            $table->string('name', 30)->nullable()->default('')->comment('name');
            $table->timestamps();
            $table->softDeletes();

            $table->comment("用户表");
        });
    }

# 密钥表
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('secrets', function (Blueprint $table) {
            $table->bigIncrements('id');
            $table->unsignedBigInteger('user_id')->index()->nullable()->default(0)->comment("user_id");
            $table->string('secret',16)->nullable()->default('')->comment("密码");
            $table->timestamps();
            $table->softDeletes();
            $table->comment("密钥表");
        });
    }

# 内容表
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('contents', function (Blueprint $table) {
            $table->bigIncrements('id');
            $table->unsignedBigInteger('user_id')->index()->nullable()->default(0)->comment('用户id');
            $table->unsignedBigInteger("secret_id")->index()->nullable()->default(0)->comment("密钥id");
            $table->string("content", 1024)->nullable()->default("")->comment("内容");
            $table->tinyInteger('type')->nullable()->default(1)->comment("1:文本，2:音频， 3：视频");
            $table->timestamps();
            $table->softDeletes();

            $table->comment("内容表");
        });
    }
```

```shell
# 生成数据库
php bin/hyperf.php migrate
```

```shell
# config/databases配置
        'commands' => [
            'gen:model' => [
                'path' => 'app/Model',
                # 强制刷新
                'force_casts' => true,
                'inheritance' => 'Model',
                'uses' => '',
                'refresh_fillable' => true,
                'table_mapping' => [],
                # 注释
                'with_comments' => true,
            ],
        ],
```

```shell
# 生成
php bin/hyperf.php gen:model
```

> 添加枚举文件

```php
<?php

namespace App\Constants;

enum ContentType: int
{
    case TEXT = 1;

    case AUDIO = 2;

    case VIDEO = 3;
}
```

> 修改model

```php
<?php

declare(strict_types=1);
/**
 * This file is part of Hyperf.
 *
 * @link     https://www.hyperf.io
 * @document https://hyperf.wiki
 * @contact  group@hyperf.io
 * @license  https://github.com/hyperf/hyperf/blob/master/LICENSE
 */

namespace App\Model;

use App\Constants\ContentType;
use Carbon\Carbon;

/**
 * @property int $id 
 * @property int $users_id 用户id
 * @property int $secrets_id 密钥id
 * @property string $content 内容
 * @property \App\Constants\ContentType $type 1:文本，2:音频， 3：视频
 * @property Carbon $created_at 
 * @property Carbon $updated_at 
 * @property string $deleted_at 
 */
class Content extends Model
{
    /**
     * The table associated with the model.
     */
    protected ?string $table = 'contents';

    /**
     * The attributes that are mass assignable.
     */
    protected array $fillable = ['id', 'users_id', 'secrets_id', 'content', 'type', 'created_at', 'updated_at', 'deleted_at'];

    /**
     * The attributes that should be cast to native types.
     */
    protected array $casts = ['id' => 'integer', 'users_id' => 'integer', 'secrets_id' => 'integer', 'type' => ContentType::class, 'created_at' => 'datetime', 'updated_at' => 'datetime'];
}

```

> 重新生成model

```shell
# 生成
php bin/hyperf.php gen:model

# 就可以看到枚举的类添加进来了
@property \App\Constants\ContentType $type 1:文本，2:音频， 3：视频
```

