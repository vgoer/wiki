<center>模型全文检索es</center>





[toc]







## 模型全文检索es

> > [hyperf/scout](https://github.com/hyperf/scout) 衍生于 [laravel/scout](https://github.com/laravel/scout)，我们对它进行了一些协程化改造，但保持了相同的 API。在这里感谢一下 Laravel 开发组，实现了如此强大好用的组件。本文档部分节选自 Laravel China 社区组织翻译的 Laravel 官方文档。
>
> Hyperf/Scout 为模型的全文搜索提供了一个简单的、基于驱动程序的解决方案。使用模型观察员，Scout 会自动同步你的搜索索引和模型记录。
>
> 目前，Scout 自带了一个 Elasticsearch 驱动；而编写自定义驱动程序很简单，你可以自由地使用自己的搜索实现来扩展 Scout。

### [引入组件包和 Elasticsearch 驱动](https://hyperf.wiki/3.1/#/zh-cn/scout?id=引入组件包和-elasticsearch-驱动)

```bash
composer require hyperf/scout
composer require hyperf/elasticsearch
```

Scout 安装完成后，使用 vendor:publish 命令来生成 Scout 配置文件。这个命令将在你的 config 目录下生成一个 scout.php 配置文件。

```bash
php bin/hyperf.php vendor:publish hyperf/scout
```

```php
<?php

declare(strict_types=1);
/**
 * This file is part of Hyperf.
 *
 * @link     https://www.hyperf.io
 * @document https://hyperf.wiki
 * @contact  group@hyperf.io
 * @license  https://github.com/hyperf/hyperf/blob/master/LICENSE
 */
use Hyperf\Scout\Provider\ElasticsearchProvider;

use function Hyperf\Support\env;

return [
    'default' => env('SCOUT_ENGINE', 'elasticsearch'),
    'chunk' => [
        'searchable' => 500,
        'unsearchable' => 500,
    ],
    'prefix' => env('SCOUT_PREFIX', ''),
    'soft_delete' => false,
    'concurrency' => 100,
    'engine' => [
        'elasticsearch' => [
            'driver' => ElasticsearchProvider::class,
            'index' => null,
            'hosts' => [
                # 添加密码和账号 ip是主机ip
                env('ELASTICSEARCH_HOST', 'http://elastic:6fUAe3wO3mRHXNHFZjRC@172.24.106.239:9200'),
            ],
        ],
    ],
];

```



最后，在你要做搜索的模型中添加 Hyperf\Scout\Searchable trait。这个 trait 会注册一个模型观察者来保持模型和所有驱动的同步：

```php
<?php

namespace App;

use Hyperf\Database\Model\Model;
use Hyperf\Scout\Searchable;

class Post extends Model
{
    use Searchable;
}
```





### 1. docker安装es

> [blog](https://www.cnblogs.com/shenhuanjie/p/18085468)

```php
# 创建目录 
mkdir -p ./es
    
# 权限
sudo chmod -R 777 es
    
# 启动容器
docker run -d --name es -p 9200:9200 -p 9300:9300 --privileged -v ./es/data:/usr/share/elasticsearch/data -v ./es/plugins:/usr/share/elasticsearch/plugins -v ./es/config:/usr/share/elasticsearch/config -e "discovery.type=single-node" -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" docker.elastic.co/elasticsearch/elasticsearch:8.12.0
    
    
# 重置
docker exec -it es bash
bin/elasticsearch-reset-password -u elastic -i 123456
```

> 新版：

```shell
# pull镜像
docker pull elasticsearch:8.13.4

# kibana
docker pull kibana:8.13.4
```

> 运行es

```shell
# 创建目录，设置权限
mkdir es
sudo chown -R 1000:1000 ./es
sudo chmod -R 777 ./es

docker run -d --name es \
  -e "discovery.type=single-node" \
  -e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
  -v ./es/data:/usr/share/elasticsearch/data \
  -v ./es/plugins:/usr/share/elasticsearch/plugins \
  -v ./es/logs:/usr/share/elasticsearch/logs \
  -p 9200:9200 -p 9300:9300 \
  elasticsearch:8.13.4
```

> 可以访问了: http://localhost:9200/


> 查看密码：es

```shell
# 重置密码
docker exec -it es bin/elasticsearch-reset-password -u elastic

# 账号密码
Password for the [elastic] user successfully reset.
New value: UjFMsxzQ3+uh-OlQxsW3

# Elasticsearch 8.x 默认只有在 xpack.security.enrollment.enabled=true 时，才能生成 enrollment token。
# 查看kibana需要的token

docker exec -it es bash
# 写入配置文件
echo "xpack.security.enrollment.enabled: true" >> /usr/share/elasticsearch/config/elasticsearch.yml

# 退出容器，重启容器
docker restart es

# 生成token
docker exec -it es /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token --scope kibana
```

> 安装ik分词器
>
> [github](https://github.com/infinilabs/analysis-ik)  [下载](https://release.infinilabs.com/analysis-ik/stable/)

```shell
# 插件目录
cd es/plugins/
mkdir ik
chmod -R 777 ik/

wget https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-8.13.4.zip

mv * ik
```

```shell
# 或者直接运行
bin/elasticsearch-plugin install https://release.infinilabs.com/analysis-ik/stable/elasticsearch-analysis-ik-8.13.4.zip
```



> 运行 kibana

```shell
# 创建目录，设置权限
mkdir kibana
sudo chown -R 1000:1000 ./kibana
sudo chmod -R 777 ./kibana


# 添加非管理员用户
docker exec -it es bin/elasticsearch-reset-password -u kibana_system

# 密码和用户名记得替换
docker run -d --name kibana \
  --link es:elasticsearch \
  -e "ELASTICSEARCH_HOSTS=http://elasticsearch:9200" \
  -e "ELASTICSEARCH_USERNAME=kibana_system" \
  -e "ELASTICSEARCH_PASSWORD=wb9JDUlUsOHC*L6olUUv" \
  -e "ELASTICSEARCH_SSL_VERIFICATIONMODE=none" \
  -v ./kibana/data:/usr/share/kibana/data \
  -p 5601:5601 \
  kibana:8.13.4
```

> 可以访问了：http://127.0.0.1:5601 账号密码登录。

```shell
# 用es的 
elastic / 和密码
```





### 2. 数据库准备

> 准备数据库

```shell
# 添加迁移
php bin/hyperf.php gen:migration create_news_table --create=news
```

```php
<?php

declare(strict_types=1);
/**
 * This file is part of Hyperf.
 *
 * @link     https://www.hyperf.io
 * @document https://hyperf.wiki
 * @contact  group@hyperf.io
 * @license  https://github.com/hyperf/hyperf/blob/master/LICENSE
 */
use Hyperf\Database\Migrations\Migration;
use Hyperf\Database\Schema\Blueprint;
use Hyperf\Database\Schema\Schema;

return new class extends Migration {
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('v1_news', function (Blueprint $table) {
            $table->bigIncrements('id');
            $table->string('title', 100)->nullable()->default('')->comment('标题');
            $table->string('content', 255)->nullable()->default('')->comment('文章内容');
            $table->string('author', 30)->nullable()->default('')->comment('作者');
            $table->timestamps();
            $table->softDeletes();
            $table->comment('新闻表');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('v1_news');
    }
};

```

```shell
# 执行迁移
php bin/hyperf.php migrate:fresh

# 添加模型
php bin/hyperf.php gen:model v1_news --with-comments
```

```php
<?php

declare(strict_types=1);
/**
 * This file is part of Hyperf.
 *
 * @link     https://www.hyperf.io
 * @document https://hyperf.wiki
 * @contact  group@hyperf.io
 * @license  https://github.com/hyperf/hyperf/blob/master/LICENSE
 */

namespace App\Model;

use Carbon\Carbon;
use Hyperf\Database\Model\SoftDeletes;
use Hyperf\DbConnection\Model\Model;
use Hyperf\Scout\Searchable;

/**
 * @property int $id
 * @property string $title 标题
 * @property string $content 文章内容
 * @property string $author 作者
 * @property Carbon $created_at
 * @property Carbon $updated_at
 */
class News extends Model
{
    use Searchable;

    use SoftDeletes;
    /**
     * The table associated with the model.
     */
    protected ?string $table = 'v1_news';

    /**
     * The attributes that are mass assignable.
     */
    protected array $fillable = [];

    /**
     * The attributes that should be cast to native types.
     */
    protected array $casts = ['id' => 'integer', 'created_at' => 'datetime', 'updated_at' => 'datetime'];
}

```

> 最后，在你要做搜索的模型中添加 Hyperf\Scout\Searchable trait。这个 trait 会注册一个模型观察者来保持模型和所有驱动的同步：

```shell
# 同步数据 把已经存在在数据库的数据同步到es中
php bin/hyperf.php scout:import "App\Model\News"
```

> 测试：

```shell
# 在你的elastic开发控制多台中打印数据

# Click the Variables button, above, to create your own variables.
GET ${exampleVariable1} // _search
{
  "query": {
    "${exampleVariable2}": {} // match_all
  }
}

// 创建索引
PUT /v1_news

// 获取索引
GET /v1_news

// 获取索引
GET /v1_news/_doc/2


// 删除索引
DELETE /v1_news
```



1. 添加数据

```php
<?php

declare(strict_types=1);
/**
 * This file is part of Hyperf.
 *
 * @link     https://www.hyperf.io
 * @document https://hyperf.wiki
 * @contact  group@hyperf.io
 * @license  https://github.com/hyperf/hyperf/blob/master/LICENSE
 */

use App\Controller\NewsController;
use Hyperf\HttpServer\Router\Router;


Router::addGroup('/news', function () {

    // 添加新闻
    Router::get("/add", [NewsController::class, 'add']);

    // 修改
    Router::get("/update/{id}", [NewsController::class, 'update']);

    // 删除
    Router::get("/delete/{id}", [NewsController::class, 'delete']);

    // 查询
    Router::get("/list", [NewsController::class, 'list']);

    // 搜索
    Router::get("/search", [NewsController::class, 'search']);
});

```

```php
<?php

namespace App\Controller;

use App\Model\News;
use Hyperf\HttpServer\Contract\RequestInterface;
use Hyperf\HttpServer\Contract\ResponseInterface;

class NewsController extends AbstractController
{

    public function add()
    {
        $news = new News();

        $news->title = "标题bbb";
        $news->author = "goer";
        $news->content = "<h3>hello 标题1bbbbbbbbbbbbb</h3>";
        $news->save();

        return [
            'code' => 200,
            'data' => $news,
        ];
    }

    public function update(int $id)
    {
        $news = News::find($id);
        if(!$news){
            return [
                'code' => 404,
                'data' => [],
            ];
        }
        $news->title = "标题2";
        $news->author = "goer";
        $news->content = "<h3>hello world</h3>";
        $news->save();

        return [
            'code' => 200,
            'data' => $news,
        ];
    }

    public function delete(int $id)
    {
        $news = News::find($id);
        $news->delete();

        return [
            'code' => 200,
            'data' => $news,
        ];
    }

    public function list()
    {
        $news = News::all()->toArray();
        return [
            'code' => 200,
            'data' => $news,
        ];
    }


    public function search(RequestInterface $request, ResponseInterface $response)
    {
        $keyword = $request->input('keyword');

        // var_dump($keyword);

        $con = News::search($keyword)->get()->toArray();

        return [
            'code' => 200,
            'data' => $con,
        ];
    }
}
```

