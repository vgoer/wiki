<center>缓存</center>



[toc]







## 缓存

> 缓存系统： 
>
> [hyperf/cache](https://github.com/hyperf/cache) 提供了基于 `Aspect` 实现的切面缓存，也提供了实现 `Psr\SimpleCache\CacheInterface` 的缓存类。







```shell
composer require hyperf/cache
```

> 新建redis，做持久化

```shell
mkdir -p ~/docker_date/redis_data

# 运行
docker run -d \
  --name my-redis \
  -p 6379:6379 \
  -v ~/docker_date/redis_data:/data \
  redis:7.2 \
  --appendonly yes
  
# 测试
docker exec -it my-redis redis-cli

set foo bar
get foo
```

> 新建mysql，做持久化

```shell
mkdir -p ./mysql_data

# 运行
docker run -d \
  --name my-mysql \
  -e MYSQL_ROOT_PASSWORD=yourpassword \
  -e MYSQL_DATABASE=testdb \
  -p 3306:3306 \
      -v ./mysql_data:/var/lib/mysql \
  mysql:8.0
  
# 测试
docker exec -it my-mysql mysql -uroot -p


# 记得给权限 
sudo chmod -R 777 *
sudo chown -R $USER:$USER *
```

> `修改env`

```shell
REDIS_HOST=172.24.106.239 （wsl的ip）
REDIS_AUTH=(null) 
REDIS_PORT=6379
REDIS_DB=0

DB_DRIVER=mysql
DB_HOST=172.24.106.239
DB_PORT=3306
DB_DATABASE=testdb
DB_USERNAME=root
DB_PASSWORD=yourpassword
DB_CHARSET=utf8mb4
DB_COLLATION=utf8mb4_unicode_ci
DB_PREFIX=
```



> 创建迁移和模型

```shell
php bin/hyperf.php gen:migration create_users_table --create=users
```

```php
<?php

use Hyperf\Database\Schema\Schema;
use Hyperf\Database\Schema\Blueprint;
use Hyperf\Database\Migrations\Migration;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->bigIncrements('id');
            $table->string("name", 10)->nullable()->default("")->comment("用户名");
            $table->string("email", 20)->nullable()->default("")->comment("邮箱");
            $table->string("password", 50)->nullable()->default("")->comment("密码");
            $table->datetimes();

            $table->comment("用户表");
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('users');
    }
};

```

> 创建模型

```shell
php bin/hyperf.php gen:model users
```

```php
<?php

declare(strict_types=1);

namespace App\Model;

use Hyperf\DbConnection\Model\Model;

/**
 * @property int $id 
 * @property string $name 
 * @property string $email 
 * @property string $password 
 * @property \Carbon\Carbon $created_at 
 * @property \Carbon\Carbon $updated_at 
 */
class User extends Model
{
    /**
     * The table associated with the model.
     */
    protected ?string $table = 'users';

    /**
     * The attributes that are mass assignable.
     */
    protected array $fillable = ['name', 'email', 'password'];

    /**
     * The attributes that should be cast to native types.
     */
    protected array $casts = ['id' => 'integer', 'created_at' => 'datetime', 'updated_at' => 'datetime'];
}

```

> 创建`Service/Userservice`

```php
<?php

declare(strict_types=1);

namespace App\Controller;

use App\Service\UserService;
use Hyperf\Di\Annotation\Inject;
use Hyperf\HttpServer\Annotation\AutoController;
use Hyperf\HttpServer\Contract\RequestInterface;
use Hyperf\HttpServer\Contract\ResponseInterface;
use Psr\Http\Message\ResponseInterface as Psr7ResponseInterface;

#[AutoController]
class UserController extends AbstractController
{
    // 注入
    #[Inject]
    protected UserService $userService;

    public function createUser(RequestInterface $request, ResponseInterface $response) : Psr7ResponseInterface
    {
        $data = $request->all();
        $this->userService->createUser($data);
        return $response->json(["code" => 200, "message" =>  "yes"]);
    }


    public function updateUser(RequestInterface $request, ResponseInterface $response) : Psr7ResponseInterface
    {
        $data = $request->all();
        $this->userService->updateUser($data["id"], $data);
        return $response->json(["code" => 200, "message" =>  "yes"]);
    }

    public function deleteUser(RequestInterface $request, ResponseInterface $response) : Psr7ResponseInterface
    {
        $data = $request->all();
        $this->userService->deleteUser($data["id"]);
        return $response->json(["code" => 200, "message" =>  "yes"]);
    }

    public function getUserInfo(RequestInterface $request, ResponseInterface $response) : Psr7ResponseInterface
    {
        $data = $request->all();
        $userInfo = $this->userService->getUserInfo((int)$data["id"]);
        return $response->json(["code" => 200, "message" =>  "yes", "data" => $userInfo]);
    }

}

```

> 创建控制器

```php
<?php

declare(strict_types=1);

namespace App\Controller;

use App\Service\UserService;
use Hyperf\Di\Annotation\Inject;
use Hyperf\HttpServer\Annotation\AutoController;
use Hyperf\HttpServer\Contract\RequestInterface;
use Hyperf\HttpServer\Contract\ResponseInterface;
use Psr\Http\Message\ResponseInterface as Psr7ResponseInterface;

#[AutoController]
class UserController extends AbstractController
{
    // 注入
    #[Inject]
    protected UserService $userService;

    public function createUser(RequestInterface $request, ResponseInterface $response) : Psr7ResponseInterface
    {
        $data = $request->all();
        $this->userService->createUser($data);
        return $response->json(["code" => 200, "message" =>  "yes"]);
    }

}

```

```shell
# 创建用户
http://127.0.0.1:9501/user/createUser?name=goer&email=aaa&password=10
```





> 注解缓存：

### [Cacheable](https://hyperf.wiki/3.1/#/zh-cn/cache?id=cacheable)

例如以下配置，缓存前缀为 `user`, 超时时间为 `7200`, 删除事件名为 `USER_CACHE`。生成对应缓存 KEY 为 `c:user:1`。

```shell
<?php

declare(strict_types=1);

namespace App\Service;

use App\Models\User;
use Hyperf\Cache\Annotation\Cacheable;

class UserService
{
    #[Cacheable(prefix: "user", ttl: 60, value: "_#{id}")]
    public function getUserInfo(int $id)
    {
        return User::query()->where("id", $id)->first();
    }
}

```

> ==查看redis，已经存入到缓存中。修改数据库，访问查询接口数据还是没变，就是缓存中的数据。==

### [CacheEvict](https://hyperf.wiki/3.1/#/zh-cn/cache?id=cacheevict)

CacheEvict 更容易理解了，当执行方法体后，会主动清理缓存。

```php
<?php

declare(strict_types=1);

namespace App\Service;

use Hyperf\Cache\Annotation\CacheEvict;

class UserBookService
{
    #[CacheEvict(prefix: "userBook", value: "_#{id}")]
    public function updateUserBook(int $id)
    {
        return true;
    }
}

```

