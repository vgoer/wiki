<center> 数据库查询优化 </center>





[toc]







## 数据库查询优化

> 如果应用运行缓慢或存在大量数据库查询，请按照以下性能优化提示来缩短应用的加载时间。 [blog](https://learnku.com/laravel/t/61384)







### 1. 检索大型数据集

> 本提示主要侧重于提高处理大型数据集时应用的内存使用率。
>
> 处理大的集合时，分组检索结果处理，而不是一次性检索处理。

```php
$posts = Post::all(); // 使用 eloquent
$posts = DB::table('posts')->get(); // 使用查询构造器
 foreach ($posts as $post){
 // 处理 posts 操作
}
```

> 上面的例子会从 posts 表检索所有的记录并处理。如果这个表达到了 100 多万行呢？内存将很快被耗尽。
>
> 为了避免在处理大型数据集时出现问题，我们可以检索结果子集并按照下面的方式处理它们。



1. 使用chunk 

> `chunk`是用于处理大量数据的查询结果集的方法。`chunk`方法允许您逐块处理大型数据集，而无需将整个数据集加载到内存中。

```php
// 当使用 eloquent 时
$data = User::query()
    ->chunk(100, function($posts){
        foreach($posts as $post)
        {
            $post->name = $post->name . '__goer';

            echo json_encode($post,true); // 分组取出来了
        }
    });
echo json_encode($data,true);  // ture


 // 当使用查询构造器时
$data = DB::table('users')
    ->orderBy('id')  // 必须加 orderBy
    ->chunk(100, function($posts){

        foreach($posts as $post){

            $post->name = $post->name . '__goer';

            echo json_encode($post, true);
        }
    });

echo json_encode($data,true);  // true
```





























